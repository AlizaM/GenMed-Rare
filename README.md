# GenMed-Rare

A PyTorch-based computer-vision project that focuses on improving medical image classification by synthesizing rare cases with generative models. Binary classification experiments comparing rare disease detection with/without synthetic data augmentation using the NIH Chest X-ray dataset.

## Project Overview

Improve classification performance on rare medical cases (Fibrosis) vs common cases (Effusion) by augmenting training sets with synthetic images generated by generative models. The project uses a multi-stage pipeline to filter, organize, and train on chest X-ray images.

## Current Implementation

- **Dataset**: NIH Chest X-ray (filtered for Hernia, Pneumonia, Fibrosis, Effusion)
- **Task**: Binary classification (Fibrosis vs Effusion)
- **Model**: Swin Transformer (timm library)
- **Augmentations**: Medical-safe (rotation ±10°, brightness/contrast, Gaussian noise - NO flips)
- **Training**: PyTorch with TensorBoard logging, early stopping, checkpointing

## Repository Structure

```
GenMed-Rare/
├── configs/                    # YAML configuration files
│   ├── config.yaml            # Main training configuration (Effusion vs Fibrosis)
│   └── config_test.yaml       # Quick test configuration (small dataset)
├── data/
│   ├── raw/                   # Raw data (download separately)
│   │   ├── archive.zip        # NIH Chest X-ray archive (112,120 images)
│   │   ├── Data_Entry_2017.csv # Original labels CSV
│   │   ├── train_val_list.txt # Train/val split file
│   │   └── test_list.txt      # Test split file
│   ├── interim/               # Organized data (created by scripts/filter_and_organize_data.py)
│   │   ├── train_val/         # Training + validation images organized by label
│   │   │   ├── Hernia/
│   │   │   ├── Pneumonia/
│   │   │   ├── Fibrosis/
│   │   │   └── Effusion/
│   │   ├── test/              # Test images organized by label
│   │   │   ├── Hernia/
│   │   │   ├── Pneumonia/
│   │   │   ├── Fibrosis/
│   │   │   └── Effusion/
│   │   └── filtered_data_entry.csv  # Filtered labels CSV
│   └── processed/             # Preprocessed data (created by src/data/preprocess.py)
│       └── effusion_fibrosis/
│           ├── dataset.csv         # Unified dataset with split column
│           └── dataset_test.csv    # Small test dataset (320 images)
├── outputs/                   # Training outputs (experiment-specific)
│   └── <experiment_name>/     # e.g., effusion_vs_fibrosis_baseline/
│       ├── checkpoints/       # Model checkpoints
│       │   ├── best_checkpoint.pth
│       │   └── latest_checkpoint.pth
│       ├── logs/              # TensorBoard logs
│       └── dataset_summary.csv # Dataset statistics
├── src/                       # Source code
│   ├── config/               # Configuration management
│   │   ├── __init__.py
│   │   └── config_manager.py # Dataclass-based config with type safety
│   ├── data/                 # Data pipeline
│   │   ├── __init__.py
│   │   ├── dataset.py        # PyTorch Dataset with medical augmentations
│   │   └── preprocess.py     # Binary classification data preparation
│   ├── models/               # Model definitions
│   │   ├── __init__.py
│   │   └── classifier.py     # Swin Transformer classifier
│   └── train/                # Training utilities
│       ├── __init__.py
│       └── trainer.py        # Training loop with metrics, logging, checkpointing
├── scripts/                   # Executable scripts
│   ├── filter_and_organize_data.py  # Extract & organize NIH dataset
│   ├── train_classifier.py          # Main training entry point
│   ├── create_test_dataset.py       # Create small test dataset
│   ├── test_training.py             # Quick training validation
│   ├── verify_and_fix_images.py     # Verify image availability
│   └── diagnose_missing_images.py   # Debug missing images
├── tests/                     # pytest tests
│   ├── test_config.py        # Configuration management tests
│   └── test_dataloader.py    # Dataset and dataloader tests
├── requirements.txt           # Python dependencies
├── README.md                  # This file
└── TRAINING_TEST.md           # Quick training test documentation
```

## Data Setup

### Required Files (Download Separately)

The NIH Chest X-ray dataset files should be placed in `data/raw/`:

1. **`archive.zip`** - NIH Chest X-ray dataset (112,120 PNG images, ~45GB)
   - Download from: [Kaggle NIH Chest X-rays](https://www.kaggle.com/datasets/nih-chest-xrays/data)
   - Place at: `data/raw/archive.zip`

2. **`Data_Entry_2017.csv`** - Original labels file
   - Included in the archive or download separately
   - Place at: `data/raw/Data_Entry_2017.csv`

3. **`train_val_list.txt`** and **`test_list.txt`** - Official train/test split files
   - Defines which images belong to train_val vs test sets
   - Place at: `data/raw/train_val_list.txt` and `data/raw/test_list.txt`

**Note**: The `data/interim/` directory and its contents will be created automatically by running `scripts/filter_and_organize_data.py`.

## Quick Start

### 1. Environment Setup

```bash
# Create virtual environment
python3 -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

### 2. Data Preparation

```bash
# Step 1: Extract and organize NIH dataset (creates data/interim/)
# This will filter for target labels and organize into label folders
python scripts/filter_and_organize_data.py

# Step 2: Preprocess for binary classification (creates data/processed/)
# This creates unified dataset.csv with train/val/test splits
python src/data/preprocess.py --config configs/config.yaml
```

### 3. Training

```bash
# Quick test with small dataset (recommended first)
python scripts/create_test_dataset.py  # Creates 320-image test dataset
python scripts/test_training.py        # Runs 3-epoch test (~5 minutes on CPU)

# Full training
python scripts/train_classifier.py --config configs/config.yaml

# Monitor with TensorBoard
tensorboard --logdir=outputs/<experiment_name>/logs
```

### 4. Testing

```bash
# Run all tests
pytest tests/ -v

# Run specific test suite
pytest tests/test_config.py -v
pytest tests/test_dataloader.py -v
```


