# Stable Diffusion LoRA Training Configuration

experiment:
  name: "chest_xray_medical_lora"
  description: "Medical chest X-ray model with LoRA fine-tuning"
  seed: 100

model:
  pretrained_model: "danyalmalik/stable-diffusion-chest-xray"
  use_lora: true
  lora_rank: 4
  lora_alpha: 4
  lora_target_modules:
    - "to_k"
    - "to_q"
    - "to_v"
    - "to_out.0"
    - "proj_in"
    - "proj_out"
    - "ff.net.0.proj"
    - "ff.net.2"
    - "conv1"
    - "conv2"
    - "conv_shortcut"
    - "downsamplers.0.conv"
    - "upsamplers.0.conv"
    - "time_emb_proj"
  lora_dropout: 0.1
  lora_bias: "none"

vae:
  path: "stabilityai/sd-vae-ft-mse"

data:
  data_dir: "data/diffusion_data/diffusion_data_balanced"
  csv_file: "diffusion_dataset_balanced.csv"
  image_size: 512
  center_crop: true
  random_flip: false  # Medical images should not be flipped
  prompt_template: "A chest X-ray showing {labels}"

training:
  # Core training parameters
  num_train_epochs: 20
  train_batch_size: 8
  gradient_accumulation_steps: 1  # Effective batch size = 8 * 2 = 16
  learning_rate: 0.0001
  max_grad_norm: 1.0
  
  # Memory optimization
  gradient_checkpointing: true
  mixed_precision: "fp16"
  
  # Optimizer settings
  adam_beta1: 0.9
  adam_beta2: 0.999
  adam_weight_decay: 0.01
  adam_epsilon: 1e-8
  
  # Learning rate schedule
  lr_scheduler: "constant_with_warmup"
  lr_warmup_steps: 500
  
  # Logging and checkpointing
  logging_steps: 50
  save_steps: 1000
  validation_steps: 1000
  use_tensorboard: true
  
  # Validation
  validation_prompt: "A chest X-ray showing Fibrosis"
  num_validation_images: 4
  
  # Directories
  checkpoint_dir: "outputs/diffusion_models/chest_xray_medical_lora/checkpoints"
  log_dir: "outputs/diffusion_models/chest_xray_medical_lora/logs"
  validation_image_dir: "outputs/diffusion_models/chest_xray_medical_lora/validation_images"
  
  # Data loading
  num_workers: 4

hardware:
  # Memory optimizations for lower VRAM
  enable_attention_slicing: true
  enable_vae_slicing: true
  
generation:
  num_inference_steps: 50
  guidance_scale: 7.5
  height: 512
  width: 512